name: RAG Assessment Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.11"

jobs:
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
      
      - name: Set up Python and venv
        run: |
          uv venv .venv --python ${{ env.PYTHON_VERSION }}
          echo "$PWD/.venv/bin" >> $GITHUB_PATH
      
      - name: Install dependencies
        run: |
          uv pip install -r requirements.txt
          uv pip install ruff mypy
      
      - name: Run Ruff linter
        run: ruff check . --ignore=E501
      
      - name: Run Ruff formatter check
        run: ruff format --check .
        continue-on-error: true

  test-structure:
    name: Test Code Structure
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
      
      - name: Set up Python and venv
        run: |
          uv venv .venv --python ${{ env.PYTHON_VERSION }}
          echo "$PWD/.venv/bin" >> $GITHUB_PATH
      
      - name: Install dependencies
        run: uv pip install -r requirements.txt
      
      - name: Check main.py exists
        run: test -f main.py
      
      - name: Check FastAPI app is importable
        run: python -c "from main import app; print('✅ FastAPI app imports successfully')"
      
      - name: Check required endpoints exist
        run: |
          python -c "
          from main import app
          routes = [route.path for route in app.routes]
          
          required = ['/', '/health', '/ask']
          missing = [r for r in required if r not in routes]
          
          if missing:
              print(f'❌ Missing endpoints: {missing}')
              exit(1)
          else:
              print('✅ All required endpoints present')
          "
      
      - name: Check Pydantic models
        run: |
          python -c "
          from main import Query, Answer, HealthCheck
          
          q = Query(question='test')
          assert q.question == 'test'
          assert q.audience == 'clinician'
          
          a = Answer(answer='test', sources=['src1'])
          assert a.answer == 'test'
          
          h = HealthCheck(status='ok', documents_loaded=5, embedding_model='test')
          assert h.status == 'ok'
          
          print('✅ Pydantic models validated')
          "

  test-api:
    name: Test API Endpoints
    runs-on: ubuntu-latest
    env:
      OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
      
      - name: Set up Python and venv
        run: |
          uv venv .venv --python ${{ env.PYTHON_VERSION }}
          echo "$PWD/.venv/bin" >> $GITHUB_PATH
      
      - name: Install dependencies
        run: |
          uv pip install -r requirements.txt
          uv pip install httpx pytest pytest-asyncio anyio
      
      - name: Run API tests
        run: |
          cat > test_api.py << 'EOF'
          import pytest
          from httpx import AsyncClient, ASGITransport
          from main import app

          @pytest.fixture
          def anyio_backend():
              return "asyncio"

          @pytest.mark.anyio
          async def test_root_endpoint():
              transport = ASGITransport(app=app)
              async with AsyncClient(transport=transport, base_url="http://test") as client:
                  response = await client.get("/")
              assert response.status_code == 200
              print("✅ Root endpoint works")

          @pytest.mark.anyio
          async def test_health_endpoint():
              transport = ASGITransport(app=app)
              async with AsyncClient(transport=transport, base_url="http://test") as client:
                  response = await client.get("/health")
              assert response.status_code in [200, 501, 503]
              print(f"✅ Health endpoint responds with {response.status_code}")

          @pytest.mark.anyio
          async def test_ask_endpoint():
              transport = ASGITransport(app=app)
              async with AsyncClient(transport=transport, base_url="http://test") as client:
                  response = await client.post("/ask", json={"question": "What is metformin?"})
              assert response.status_code in [200, 501, 503]
              print(f"✅ Ask endpoint responds with {response.status_code}")

          @pytest.mark.anyio
          async def test_ask_invalid_payload():
              transport = ASGITransport(app=app)
              async with AsyncClient(transport=transport, base_url="http://test") as client:
                  response = await client.post("/ask", json={"invalid": "payload"})
              assert response.status_code == 422
              print("✅ Invalid payload rejected")
          EOF
          pytest test_api.py -v

  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [lint, test-structure, test-api]
    if: always()
    steps:
      - name: Check results
        run: |
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "- Lint: ${{ needs.lint.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Structure: ${{ needs.test-structure.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- API: ${{ needs.test-api.result }}" >> $GITHUB_STEP_SUMMARY
